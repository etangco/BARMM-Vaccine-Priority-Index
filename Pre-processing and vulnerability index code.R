# set the needed libraries
library(ggplot2)
library(dplyr)
library(readxl)
oldw <- getOption("warn")
options(warn = -1)
#options(warn = oldw)

# FOR POPULATION DATA

population<- read.csv("ARMMPopulation2010-2015.csv")

#Get the sum for each age distribution
sumpoplist<-NULL

#get for ages 0 to 60
for (j in 0:5){
    sumpoplist2<-NULL
    for (i in 1:nrow(population)){
        poplist<-NULL
        for (l in 1:10){
            n<- j*10+l
            if (n==1){
                poplist<-c(poplist,as.numeric(paste(population[i,"sin_age_bot_und_001"]))) #to include less than 1 year old
            }
            if (n<10){
                age <- paste0("sin_age_bot_00",n) #for formatting of those lessthan 10 years old
            }
            if (n>=10){
                age <- paste0("sin_age_bot_0",n) #for greater than 10 years old
            }
            poplist<- c(poplist,as.numeric(paste(population[i,grep(age,colnames(population))]))) 
        }
        sumpoplist2<- c(sumpoplist2,sum(poplist))
    }
    denote<- paste0("age_cut",j)
    population[denote]<- sumpoplist2 #will have for each 10 years a secific column, ex:age_cut0 means 0-10 years old
}

# for 60 and above
for (i in 1:nrow(population)){
    poplist<-NULL
    for (k in grep("sin_age_bot_060",colnames(population)):grep("sin_age_bot_080_and_ove",colnames(population))){
        poplist<-c(poplist,as.numeric(paste(population[i,k])))
    }
    sumpoplist<-c(sumpoplist,sum(poplist)) #put na.rm=TRUE if you want value to be 0 for NA
}
population['vulpop']<-sumpoplist


#get the arranged population
arrangedpopulation<- population %>% 
    group_by(PSGC_CITY.MUNI) %>% 
    summarise(ProviCode=first(PSGC_PROV),Region=first(REGI),Municipality=first(MuniCities),Pop2015=sum(Pop2015),HHnum=sum(as.numeric(paste(num_hh0))),Malepop=sum(as.numeric(paste(tot_sin_age_mal))),Femalepop=sum(as.numeric(paste(tot_sin_age_fem))),Age_0_10=sum(age_cut0),Age_11_20=sum(age_cut1),Age_21_30=sum(age_cut2),Age_31_40=sum(age_cut3),Age_41_50=sum(age_cut4),Age_51_60=sum(age_cut5),vulnerable=sum(vulpop)) %>% distinct()
colnames(arrangedpopulation)[1]<- "MuniCode"

#adding density into the dataset
municipalityAreas<- read_excel("mun_areas.xlsx",sheet=1)
colnames(municipalityAreas)[1]<-"MuniCode"
arrangedpopulation<-Reduce(function(x, y) merge(x, y,by="MuniCode",all=TRUE), list(arrangedpopulation, municipalityAreas))
arrangedpopulation$populationDensity<- arrangedpopulation$Pop2015/arrangedpopulation$Area

write.csv(arrangedpopulation,'ProcessedPopulation2015.csv')

#-------------------------------------------------------------------------------

# Adding schools to the datalist
schools<- read.csv("SchoolsperMuni.csv")
schools<- schools %>% select(MuniCode=PSGC_CITY.MUNI,NumSchools=Number.of.School)
arrangedDataset<- merge(arrangedpopulation,schools,by="MuniCode",all="TRUE")
infrastractureDataset<-arrangedDataset

#to get a list of all the municipality codes for the future
MuniCodes<- NULL
for (i in 1:nrow(arrangedDataset)){
    MuniCodes<- c(MuniCodes,as.character(arrangedDataset[i,1]))
}
MuniData<- data.frame(MuniCodes=MuniCodes,stringsAsFactors=FALSE)
write.csv(MuniData,"MunicipalityCodes.csv")

#to get a list of municipality names in the future
Municipalities<- NULL
for (i in 1:nrow(arrangedDataset)){
    Municipalities<- c(Municipalities,as.character(arrangedDataset[i,4]))
}

write.csv(arrangedDataset,"processedData.csv")

#-------------------------------------------------------------------------------

# FOR COVID DATASET
#Filter data based on BARMM only
covidData<- read.csv('Coviddata.csv')
covidData<- filter(covidData, CityMuniPSGC %in% MuniCodes)
write.csv(covidData,"Coviddata.csv")

#save data for future purposes
newCovidData<-covidData[as.character(covidData$RemovalType)=='',]
write.csv(covidData,"newCoviddata.csv")

#get covid 19 related features (see CODEBOOK for details) for each municipality in BARMM
arrangedCovidData<-covidData %>% mutate(current=ifelse(as.character(covidData$RemovalType)=='',1,0),recovered=ifelse(as.character(covidData$RemovalType)=='RECOVERED',1,0),died=ifelse(as.character(covidData$RemovalType)=='DIED',1,0),totalcase=1)
arrangedCovidData<- arrangedCovidData %>% group_by(CityMuniPSGC) %>% summarise(currentCovid=sum(current),recovered=sum(recovered),died=sum(died),totalcase=sum(totalcase)) %>% distinct() %>% mutate(CaseFatalRate=died/totalcase,RecoverRate=recovered/totalcase)
colnames(arrangedCovidData)[1]<- "MuniCode"
write.csv(arrangedCovidData,"pathologicalData.csv")

arrangedDataset1<-Reduce(function(x, y) merge(x, y,by="MuniCode",all=TRUE), list(arrangedDataset, arrangedCovidData))

#-------------------------------------------------------------------------------

# FOR ECONOMIC DATA
# get economic data for each municipality
economicData<- read_excel('Economic-Factors-Complete.xlsx')
colnames(economicData)[4]<-"MuniCode"
economicData<- economicData %>% select(-c(colnames(economicData)[1:3]))

povertyData<- read.csv("povertyrank.csv")
colnames(povertyData)[1]<- "MuniCode"
arrangedDataset2<-Reduce(function(x, y) merge(x, y,by="MuniCode",all=TRUE), list(arrangedDataset1, economicData))
arrangedDataset2<-Reduce(function(x, y) merge(x, y,by="MuniCode",all=TRUE), list(arrangedDataset2, povertyData))

#-------------------------------------------------------------------------------

# For Health Infrastracture
#health workers data
healthProfData<- read.csv("healthcareProfessionals.csv")
colnames(healthProfData)[6]<-"MuniCode"
healthProfData$totalHealthProf <- rowSums(healthProfData[,8:10])
healthProfData<- healthProfData %>% group_by(MuniCode) %>% summarise(healthProfessionals=sum(totalHealthProf)) %>% distinct()
write.csv(healthProfData,"healthWorkers.csv")

# bed Data
bedData<- read.csv("hospitalBeds.csv")
colnames(bedData)[12]<- "ProviCode"
bedData$totalBeds<- rowSums(bedData[,5:8])
bedData$occupiedBeds<- rowSums(bedData[,c(6,8)])
bedData<- bedData %>% group_by(ProviCode) %>% summarise(numberOfBeds=sum(totalBeds,na.rm=TRUE),numberOfOccupiedBeds=sum(occupiedBeds,na.rm=TRUE),occupancyRate=sum(occupiedBeds,na.rm=TRUE)/sum(totalBeds,na.rm=TRUE))
write.csv(bedData,"provincialBeds.csv")

# RHU and BHS data
rhubhsData<- read_excel("RHUBHS.xlsx")
colnames(rhubhsData)[1]<- "MuniCode"
rhubhsData[,5]<- as.numeric(unlist(rhubhsData[,5]))
rhubhsData[,6]<- as.numeric(unlist(rhubhsData[,6]))
rhubhsData$totalUnits<- rowSums(rhubhsData[,5:6])
rhubhsData<- rhubhsData %>% select(MuniCode,totalUnits)
write.csv(rhubhsData,"RHUandBHSData.csv")

#merging the data
arrangedDataset2<-Reduce(function(x, y) merge(x, y,by="MuniCode",all=TRUE), list(arrangedDataset2, rhubhsData))
arrangedDataset2<-Reduce(function(x, y) merge(x, y,by="MuniCode",all=TRUE), list(arrangedDataset2, healthProfData))
arrangedDataset2<-Reduce(function(x, y) merge(x, y,by="ProviCode",all=TRUE), list(arrangedDataset2, bedData))

#-------------------------------------------------------------------------------

# FOR HOUSEHOLD DATA

#household data to merge with population and aranngedDataset
householdData<- data.frame(read_excel("Table-2_8.xlsx")[,-2])
householdData<- householdData[complete.cases(householdData),]
colnames(householdData)<- c('Municipality',householdData[1,-1])
for (i in 1:nrow(householdData)){
    householdData[i,1]<- stringr::str_to_title(householdData[i,1])
}

#to get only the BARMM data for Household Data + preprocessing
householdData<- filter(householdData,Municipality %in% Municipalities)
householdData[householdData$Municipality=="Carmen",]<- householdData[householdData$Municipality=="Carmen" & householdData["Household Population"]=="95865",]
householdData[householdData$Municipality=="Tagoloan",]<- householdData[householdData$Municipality=="Tagoloan" & householdData["Household Population"]=="13229",]
householdData[householdData$Municipality=="Tuburan",]<- householdData[householdData$Municipality=="Tuburan" & householdData["Household Population"]=="20207",]
householdData[householdData$Municipality=="Kapatagan",]<- householdData[householdData$Municipality=="Kapatagan" & householdData["Household Population"]=="15487",]
householdData<- householdData %>% distinct()
householdData[,"Average Household Size"]<- as.numeric(unlist(householdData[,"Average Household Size"]))
write.csv(householdData,"householdData.csv")

#to merge household Data to the whole dataframe
arrangedDataset3<-Reduce(function(x, y) merge(x, y,by="Municipality",all=TRUE), list(arrangedDataset2, householdData))
arrangedDataset3<- arrangedDataset3[-c(87,90),] #remove repeating data

#-------------------------------------------------------------------------------

#Doing the ranking part and making the vulnerability index
# creating a function for normalization
normalize <-function (x){
    (x-range(x,na.rm=TRUE)[1])/(range(x,na.rm=TRUE)[2]-range(x,na.rm=TRUE)[1])
}

#Normalization but those with higher values have lower ndex
normalize2 <-function (x){
    (range(x,na.rm=TRUE)[2]-x)/(range(x,na.rm=TRUE)[2]-range(x,na.rm=TRUE)[1])
}

normalize3 <-function (x){
    trueMax<- Rfast::nth(x,1,descending=T,na.rm=TRUE)
    nextMax<- Rfast::nth(x,2,descending=T,na.rm=TRUE)
    ifelse(x==trueMax,1,((x-range(x,na.rm=TRUE)[1])/(nextMax-range(x,na.rm=TRUE)[1]))*0.95)
}

#creating a new column for the normalized values of each feature needed
arrangedDataset4<- data.frame(MuniCode=arrangedDataset3$MuniCode,Municipality=arrangedDataset3$Municipality)

#Demographic Data
arrangedDataset3$vulnerableratio<- arrangedDataset3$vulnerable/arrangedDataset3$Pop2015
arrangedDataset4$vulnerableScore<- normalize(arrangedDataset3$vulnerableratio)
arrangedDataset4$averageHouseScore<- normalize(arrangedDataset3[,"Average Household Size"])
arrangedDataset4$popDensityScore<- normalize(arrangedDataset3$populationDensity)
arrangedDataset4$demographicScore<- normalize(rowSums(arrangedDataset4[,3:5],na.rm=TRUE))*10

#Financial Data
#Merging economic Dataset with ranks (done on another code)
arrangedDataset4$povertyScore<- arrangedDataset3$Score
arrangedDataset4$finConScore<- normalize2(arrangedDataset3$EQUITY)
arrangedDataset4$cashPosScore<- normalize2(arrangedDataset3$SURPLUS)
arrangedDataset4$financialScore<- normalize(rowSums(arrangedDataset4[,7:9],na.rm=TRUE))*10

# Health Infrastracture Factors
arrangedDataset3$rhubhsratio<- arrangedDataset3$totalUnits/arrangedDataset3$Pop2015
arrangedDataset3$healthworkersratio<- arrangedDataset3$healthProfessionals/arrangedDataset3$Pop2015
arrangedDataset3<-arrangedDataset3 %>% group_by(ProviCode) %>% mutate(sumbyprovince=sum(Pop2015,na.rm=TRUE)) %>% mutate(bedratio=numberOfBeds/sumbyprovince)
arrangedDataset4$rhubhsScore<- normalize2(arrangedDataset3$rhubhsratio)
arrangedDataset4$healthWorkerScore<- normalize2(arrangedDataset3$healthworkersratio)
arrangedDataset4$numberOfBedScore<- normalize2(arrangedDataset3$bedratio)
arrangedDataset4$healthInfrastractureScore<- normalize(rowSums(arrangedDataset4[,11:13],na.rm=TRUE))*10

#Epidemiological Factors
arrangedDataset4$totalCaseScore<- normalize3(arrangedDataset3$totalcase/arrangedDataset3$Pop2015)
arrangedDataset4$activeCaseScore<- normalize3(arrangedDataset3$currentCovid/arrangedDataset3$Pop2015)
arrangedDataset4$caseFatalScore<- arrangedDataset3$CaseFatalRate
arrangedDataset4$epidomiologicalScore<- normalize(rowSums(arrangedDataset4[,15:17],na.rm=TRUE))*10

#getting total index score
arrangedDataset4$totalScore<- rowMeans(arrangedDataset4[,c(6,10,14,18)],na.rm=TRUE)

#Ranking the data
arrangedDataset4$demographicRank<- rank(-arrangedDataset4$demographicScore,na.last=TRUE,ties.method="min")
arrangedDataset4$financialRank<- rank(-arrangedDataset4$financialScore,na.last=TRUE,ties.method="min")
arrangedDataset4$healthInfrastractureRank<- rank(-arrangedDataset4$healthInfrastractureScore,na.last=TRUE,ties.method="min")
arrangedDataset4$epidomiologicalRank<- rank(-arrangedDataset4$epidomiologicalScore,na.last=TRUE,ties.method="min")
arrangedDataset4$totalScoreRank<- rank(-arrangedDataset4$totalScore,na.last=TRUE,ties.method="min")

# convert all NA values into column mean (for dashboard)
for (n in 3:ncol(arrangedDataset4)){
    arrangedDataset4[is.na(arrangedDataset4[,n]),n] <- mean(arrangedDataset4[,n],na.rm=TRUE)
}

#Saving the data
write.csv(arrangedDataset4,"rankingData.csv")
